# 손익계산서

컬럼 및 월말예상 로직 개선

## 개요

손익계산서 테이블의 컬럼 구조 변경 및 Tag매출/실판(V+)/실판(V-)/매출원가의 월말예상 계산 로직을 하위 채널별 라인 기준으로 재구성합니다.

## 변경 범위

- **대상 항목**: Tag매출, 실판(V+), 실판(V-), 매출원가(합계) 및 각각의 하위 4개 채널 라인
- **제외 항목**: 직접비, 영업비 등은 기존 로직 유지

## 변경 파일

### 1. [src/lib/plforecast/types.ts](src/lib/plforecast/types.ts)

- `PlLine` 인터페이스에 필드 추가:
- `prevYearAccum?: number | null` - 전년 누적 (D일까지)
- `prevYearProgressRate?: number | null` - 전년 진척률 (전년 누적 / 전년 월전체)

### 2. [src/lib/plforecast/snowflake.ts](src/lib/plforecast/snowflake.ts)

- `getPrevYearChannelAccum` 함수 추가 (약 400줄 이후)
- 파라미터: `prevYm: string, lastDt: string, brandCode: BrandCode`
- 반환: `Promise<{ tagSale: ChannelRowData; actSaleVatInc: ChannelRowData; actSaleVatExc: ChannelRowData; cogs: ChannelRowData }>`
- SQL: 전년도 해당 월의 1일부터 D일까지 누적 조회 (채널별)
- 컬럼: TAG_SALE_AMT, ACT_SALE_AMT, VAT_EXC_ACT_SALE_AMT, ACT_COGS
- 채널 구분: chnl_cd와 trans_cd 기준 (기존 getPrevYearChannelActuals와 동일)
- `getPrevYearChannelFullMonth` 함수 추가 (위 함수 다음)
- 파라미터: `prevYm: string, brandCode: BrandCode`
- 반환: `Promise<{ tagSale: ChannelRowData; actSaleVatInc: ChannelRowData; actSaleVatExc: ChannelRowData; cogs: ChannelRowData }>`
- SQL: 전년도 해당 월 전체 합계 조회 (채널별)
- 전년 진척률 계산의 분모로 사용

### 3. [src/app/api/pl-forecast/route.ts](src/app/api/pl-forecast/route.ts)

#### 3-1. import 추가 (약 28줄)

- `getPrevYearChannelAccum`, `getPrevYearChannelFullMonth` import 추가

#### 3-2. `channelData` 타입 확장 (약 1248줄)

- `prevYearChannelAccum?: { tagSale: ChannelRowData; actSaleVatInc: ChannelRowData; actSaleVatExc: ChannelRowData; cogs: ChannelRowData }` 추가
- `prevYearChannelFullMonth?: { tagSale: ChannelRowData; actSaleVatInc: ChannelRowData; actSaleVatExc: ChannelRowData; cogs: ChannelRowData }` 추가

#### 3-3. `channelData` 생성 시 전년 누적/월전체 데이터 추가 (약 1259줄)

- `getPrevYearChannelAccum(prevYm, lastDt, brandCode)` 호출하여 전년 D일까지 누적 조회
- `getPrevYearChannelFullMonth(prevYm, brandCode)` 호출하여 전년 월전체 조회
- `prevYearChannelAccum`, `prevYearChannelFullMonth`에 할당

#### 3-4. `buildPlLine` 함수 수정

##### 3-4-1. `channelTagSale` 케이스 수정 (약 177줄 이후)

- `prevYearAccum`: `channelData.prevYearChannelAccum?.tagSale[channel] || null`
- `prevYearFullMonth`: `channelData.prevYearChannelFullMonth?.tagSale[channel] || null`
- `prevYearProgressRate`: 분모가 0이면 null, 아니면 `prevYearAccum / prevYearFullMonth`
- **월말예상 계산**:
- 대리상(onlineDealer, offlineDealer): `target` 그대로
- 직영(onlineDirect, offlineDirect): 
- 전년 진척률이 있으면: `(accum / prevYearProgressRate)`
- 없으면: `null`

##### 3-4-2. `channelVatInc` 케이스 수정 (약 155줄)

- `prevYearAccum`, `prevYearFullMonth`, `prevYearProgressRate` 추가
- **월말예상 계산**: channelTagSale과 동일한 로직

##### 3-4-3. `channelCogs` 케이스 수정 (약 217줄 이후)

- `prevYearAccum`, `prevYearFullMonth`, `prevYearProgressRate` 추가
- **월말예상 계산**:
- 대리상: `target` 그대로
- 직영:
- Tag매출 월말예상이 null이면: `null`
- Tag매출 누적이 0이면: `null`
- Tag대비 원가율 = `(cogsAccum * 1.13) / tagSaleAccum`
- 월말예상 매출원가 = `(tag대비원가율 * tagSaleForecast) / 1.13`

##### 3-4-4. `vatExcluded` 케이스 수정 (약 176줄)

- 실판(V-)도 채널별 하위 라인이 있으므로, channelData에서 처리하도록 변경 필요
- 또는 새로운 `channelVatExc` 타입 추가

##### 3-4-5. 상위 합계 라인 계산 로직 추가

- `tag-sale`, `act-sale-vat-inc`, `cogs-sum`의 부모 행에서:
- 하위 4개 채널 라인의 합으로 `prevYear`, `target`, `accum`, `forecast` 계산
- `prevYearAccum`, `prevYearProgressRate`도 하위 합산
- `-` 값 처리: 하위가 전부 null이면 null, 일부만 null이면 숫자 합산

#### 3-5. `buildPlLine` 반환값 수정 (약 483줄)

- `prevYearAccum`, `prevYearProgressRate` 필드 포함

### 4. [src/app/pl-forecast/[brand]/page.tsx](src/app/pl-forecast/[brand]/page.tsx)

#### 4-1. 테이블 헤더 수정 (약 2950줄)

- 컬럼 순서 변경:
- 전년
- (전년)누적 (showAccum과 연동)
- (전년)진척률 (showAccum과 연동)
- 목표
- 누적 (showAccum과 연동)
- 월말예상
- 전년비
- 달성율

#### 4-2. `renderRow` 함수 수정 (약 2519줄)

- `prevYearAccum` 컬럼 추가 (showAccum 조건부)
- `prevYearProgressRate` 컬럼 추가 (showAccum 조건부, 백분율 포맷, 소수 1자리)
- 컬럼 순서 조정

#### 4-3. colSpan 수정 (약 2970줄)

- showAccum에 따라 colSpan 값 조정 (기존 7 → 9)

### 5. [src/app/pl-forecast/page.tsx](src/app/pl-forecast/page.tsx)

- 전체 페이지의 손익계산서도 동일하게 수정 (약 810줄)
- 헤더 및 `renderRow` 함수 동일하게 적용

### 6. 범례 섹션 수정

#### 6-1. [src/app/pl-forecast/[brand]/page.tsx](src/app/pl-forecast/[brand]/page.tsx) (약 2980줄)

- 범례 섹션에 매출 및 매출원가 채널별 계산 로직 추가
- **Tag매출, 실판(V+), 실판(V-) 채널별 계산** 섹션 추가:
- 대리상 (온라인 대리상, 오프라인 대리상): 월말예상 = 목표
- 직영 (온라인 직영, 오프라인 직영): 월말예상 = 누적 ÷ 전년 진척률
- 전년 진척률 = (전년 D일까지 누적) ÷ (전년 월전체)
- 전년 데이터가 없거나 분모가 0이면 "-"
- **매출원가 채널별 계산** 섹션 추가:
- 대리상 (온라인 대리상, 오프라인 대리상): 월말예상 = 목표
- 직영 (온라인 직영, 오프라인 직영): 
- Tag대비 원가율 = (누적 매출원가 × 1.13) ÷ 누적 Tag매출
- 월말예상 매출원가 = (Tag대비 원가율 × 월말예상 Tag매출) ÷ 1.13
- 예외: Tag매출 누적이 0이거나 월말예상 Tag매출이 "-"이면 "-"

#### 6-2. [src/app/pl-forecast/page.tsx](src/app/pl-forecast/page.tsx) (약 842줄)

- 전체 페이지의 범례도 동일하게 수정

## 데이터 흐름

1. **기준일 D 결정**: `getLastDates`로 현재 월의 최신 CSV 파일 날짜 추출
2. **전년 데이터 조회**: 

- `getPrevYearChannelAccum`: 전년 D일까지 누적 (채널별)
- `getPrevYearChannelFullMonth`: 전년 월전체 (채널별)

3. **전년 진척률 계산**: `prevYearAccum / prevYearFullMonth` (채널별)
4. **월말예상 계산**:

- 대리상: 목표 그대로
- 직영 Tag매출/V+/V-: `accum / prevYearProgressRate`
- 직영 매출원가: Tag대비 원가율 기반

5. **상위 합계**: 하위 4개 채널 합산

## 참고사항